/*
  ScarletsFrame v0.6.2
  A frontend library for Scarlets Framework that support
  lazy page load and element binding that can help
  simplify your code

  https://github.com/ScarletsFiction/ScarletsFrame
*/
"undefined"==typeof sf&&(sf=function(){if(arguments[0].constructor===Function)return sf.loader.onFinish.apply(null,arguments)}),setTimeout(function(){sf(function(){sf.model.queuePreprocess(),sf.model.parsePreprocess(),$("[sf-controller]").each(function(){sf.router.init(this.attributes["sf-controller"].value)})})},10),$.fn.extend({animateCSS:function(e,t,r){var n=this,o={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"mozAnimationEnd",WebkitAnimation:"webkitAnimationEnd"};for(var i in o)if(void 0!==n[0].style[i]){o=o[i];break}return r&&n.css("-webkit-animation-duration",r+"s").css("animation-duration",r+"s"),n.addClass("animated "+e).one(o,function(){setTimeout(function(){$(n).removeClass("animated "+e)},1),r&&$(n).css("-webkit-animation-duration","").css("animation-duration",""),"function"==typeof t&&t()}),n}}),sf.controller=new function(){var self=this,controller={};self.active={},self.for=function(e,t){sf.model.root[e]||(sf.model.root[e]={}),controller[e]=t},self.fromElement=function(e){var t=$(e),r=t.parents("[sf-model]").attr("sf-model");return r||(r=t.parents("[sf-controller]").attr("sf-controller")),r};var listenSFClick=function(e){var element=$(e.target),script=element.attr("sf-click");script||(element=element.parents("[sf-click]").eq(0),script=element.attr("sf-click"));var model=element.parents("[sf-model]").attr("sf-model");if(sf.model.root[model]||(model=element.parents("[sf-controller]").attr("sf-controller")),!sf.model.root[model])throw"Couldn't find model for "+model+" that was called from sf-click";var _modelScope=sf.model.root[model],modelKeys=sf.model.modelKeys(_modelScope),scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+modelKeys+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");script=script.replace(scopeMask,function(e,t){return"_modelScope."+t}),script=script.split("(");var method=script[0],method_=method;try{method=eval(method)}catch(e){method=!1}if(method){script.shift(),script=script.join("("),script=script.split(")"),script.pop(),script=script.join("("),0!==script.length&&(script=eval("["+script+"]")),script||(script=[]);try{method.apply(element,script)}catch(e){console.error("Error on sf-click for model: "+model+"\n",e.target,"\n",e)}}else console.error("Error on sf-click for model: "+model+" [Cannot find "+method_+"]\n",e.target)};self.run=function(e,t){if(!sf.loader.DOMWasLoaded)return sf(function(){self.run(e,t)});controller[e]&&(self.active[e]||(controller[e]&&controller[e](sf.model.root[e],sf.model.root),$('[sf-controller="'+e+'"]').on("click","[sf-click]",listenSFClick),self.active[e]=!0)),t&&t(sf.model.root[e],sf.model.root),controller[e]&&delete controller[e]},self.init=function(){if(!sf.loader.DOMWasLoaded)return sf(function(){self.init(name)});$("[sf-controller]").each(function(){self.run(this.attributes["sf-controller"].value)})}},sf.loader=new function(){var e=this;e.loadedContent=0,e.totalContent=1,e.DOMWasLoaded=!1;var t=[],r=[];e.onFinish=function(r){if(e.DOMWasLoaded)return r();-1===t.indexOf(r)&&t.push(r)},e.onProgress=function(t){if(e.DOMWasLoaded)return t(e.loadedContent,e.totalContent);-1===r.indexOf(t)&&r.push(t)},e.f=function(t){e.loadedContent++;for(var n=0;n<r.length;n++)r[n](e.loadedContent,e.totalContent);t&&t.removeAttribute("onload")},e.css=function(t){e.totalContent=e.totalContent+t.length;for(var r="",n=0;n<t.length;n++)r+='<link onload="sf.loader.f(this)" rel="stylesheet" href="'+t[n]+'">';document.getElementsByTagName("head")[0].innerHTML+=r},e.js=function(t,r="head"){e.totalContent=e.totalContent+t.length;for(var n="",o=0;o<t.length;o++)n+='<script onload="sf.loader.f(this)" type="text/javascript" src="'+t[o]+'"><\/script>';$(n).appendTo(r)};var n=setInterval(function(){if(/loaded|complete/.test(document.readyState)){clearInterval(n),e.DOMWasLoaded=!0;for(var o=0;o<t.length;o++)t[o]();r.splice(0),t.splice(0)}},100)},sf.prototype.constructor=sf.loader.onFinish,sf.model=new function(){var self=this;self.root={};var bindingEnabled=!1;self.fromElement=function(e,t=!1){var r=$(e),n=sf.controller.fromElement(e);if(!n)throw"model or controller was not found";var o=r.attr("[sf-bind-list]");if(o||(o=r.parents("[sf-bind-list]").attr("sf-bind-list")),!o)return t?t(self.root[n],-1):self.root[n];var i=0;return o&&(i=r.parents("[sf-bind-list]").prevAll("[sf-bind-list]").length),t?t(self.root[n][o],i):self.root[n][o][i]},self.for=function(e,t){self.root[e]||(self.root[e]={}),t(self.root[e],self.root)},self.modelKeys=function(e){for(var t=Object.keys(e),r=t.length-1;r>=0;r--)-1!==t[r].indexOf("$")&&t.splice(r,1);return t.join("|")};var clearElementData=function(e){e.innerHTML="";for(var t=0;t<e.attributes.length;t++){var r=e.attributes[t].name;"sf-bind-list"!==r&&e.removeAttribute(r)}e.setAttribute("style","display:none")},dataParser=function(html,model,mask,scope,runEval=""){var scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(model)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");if(mask)var itemMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )"+mask+"\\.(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");bindingEnabled=!0;var _modelScope=sf.model.root[scope];return html.replace(/{{([^@].*?)}}/g,function(actual,temp){return temp=temp.replace(scopeMask,function(e,t){return"_modelScope."+t}),mask&&(temp=temp.replace(itemMask,function(e){return"model."+e[0].slice(1)})),temp=temp.split("(").join("").split(")").join(""),temp=eval(runEval+temp),temp})},uniqueDataParser=function(html,model,mask,scope){for(var _content_={length:0,take:function(e,t){var r='"use strict";var ',n=!0;for(var o in e)"string"==typeof e[o]?e[o]='"'+e[o].split('"').join('\\"')+'"':"object"==typeof e[o]&&(e[o]=JSON.stringify(e[o])),n||(r+=","),r+=o+" = "+e[o],n=!1;return r=r.split("(").join("").split(")").join(""),dataParser(this[t],model,mask,scope,r+";")}},VarPass=["i","obj"],i=0;i<VarPass.length;i++)VarPass[i]+=":(typeof "+VarPass[i]+'!="undefined"?'+VarPass[i]+":null)";VarPass="{"+VarPass.join(",")+"}",html=html.replace(/{\[(.*?)\]}/gs,function(e,t){return _content_[_content_.length]=t,_content_.length++,"result += _content_.take("+VarPass+", "+(_content_.length-1)+");"});var scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(model)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g"),_modelScope=sf.model.root[scope];if(mask)var itemMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )"+mask+"\\.(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");return html.replace(/{{(@.*?)}}/gs,function(actual,temp){temp=temp.replace(scopeMask,function(e){return"_modelScope."+e[1].slice(1)}),mask&&(temp=temp.replace(itemMask,function(e){return"model."+e[1].slice(1)})),temp=temp.split(":"),temp[0]=temp[0].split("(").join("").split(")").join(""),temp=temp.join(":");var result="",check=!1;if(check=temp.split("@if "),1!=check.length&&(check=check[1].split(":"),eval(check[0])&&(check.shift(),result=check.join(":"))),check=temp.split("@call"),1!=check.length){check=check[1].trim();var call=check.split("@"),args=[];if(1!==call.length){args=call[1],args=args.split(" ").join("").split(",");for(var a=0;a<args.length;a++)args[a]=eval(args[a])}if(call=call[0],!sf.model.root[scope][call])throw"'"+call+"' was not available inside '"+scope+"' model";var values=sf.model.root[scope][call].apply(null,args);result=values}if(check=temp.split("@exec"),1!=check.length){check=check[1].split("&lt;").join("<").split("&gt;").join(">").split("&amp;").join("&");for(var regex=/(for|if|while)#(.*?):/gs,match=regex.exec(check);null!==match;)check=check.replace(match[0],match[1]+"("+match[2]+")"),match=regex.exec(check);var currentIndex=i;try{eval(check)}catch(e){return void console.error("Error in @exec with message: "+e.message)}i=currentIndex}return result})},bindArray=function(e,t,r,n,o){for(var i=JSON.parse(JSON.stringify(t)),a=["pop","push","splice","shift","unshift","refreshBind"],s=function(t,i=!1,a=!1){var s=$("[sf-model='"+n+"']");if(0===s.length&&(s=$("[sf-controller='"+n+"']")),0!==s.length){s=s.find("[sf-bind-list='"+o+"']");var l=!1;if(self.root[n]["on$"+o]&&(l=self.root[n]["on$"+o]),i){var f=self.root[n][o][t],c=dataParser(e,f,r,n);c=uniqueDataParser(c,f,r,n),c=$(c),s[t]?a?(l.create&&l.create(c[0]),c.insertBefore(s[0])):(l.update&&l.update(c[0]),s[t].outerHTML=c[0].outerHTML):(l.create&&l.create(c[0]),c.insertAfter(s[s.length-1]))}else if(s[t]){var d=!1,u=function(){if(!d){if(d=!0,s.length<=1)return clearElementData(s[t]);s[t].remove()}};l.remove?l.remove(s[t],u)||setTimeout(u,800):u()}}},l=function(e,t){Object.defineProperty(e,t,{value:function(){var e=void 0;if(Array.prototype[t]&&(e=Array.prototype[t].apply(this,arguments)),"pop"===t)s(this.length);else if("push"===t)s(this.length-1,!0);else if("shift"===t)s(0);else if("splice"===t)if(arguments.length>=3)arguments[0]=!1,t="refreshBind";else{var r=arguments[0];r<0&&(r=this.length+r+1);var n=arguments[1];n||(n=this.length-r);for(var o=0;o<n;o++)s(r)}else"unshift"===t&&s(0,!0,!0);if("refreshBind"===t)if(arguments[0]||0===arguments[0])s(arguments[0],!0);else{var a=!1;for(o=0;o<this.length;o++)JSON.stringify(i[o])!==JSON.stringify(this[o])&&(a=!0,s(o,!0));a&&(i=JSON.parse(JSON.stringify(this)))}return e}})},f=0;f<a.length;f++)l(t,a[f])},loopParser=function(e,t,r){var n="",o=r.split(" in "),i=o[0];if(!sf.model.root[e])return console.error("Can't parse element because model for '"+e+"' was not found",$(t)[0]);var a=self.root[e][o[1]];if(t=(t=$(t).attr("sf-bind-list",o[1])[0].outerHTML).replace(/  +|\t+/g,""),2===o.length){for(var s in a){var l=a[s];temp=dataParser(t,l,i,e),temp=uniqueDataParser(temp,l,i,e),n+=temp}Object.defineProperty(self.root[e],o[1],{enumerable:!0,configurable:!0,get:function(){return a},set:function(e){for(var t=0;t<e.length;t++)a[t]?(a[t]=e[t],a.refreshBind(t)):a.push(e[t]);return a.length>e.length&&a.splice(a.length-e.length),a}}),bindArray(t,a,i,e,o[1])}return n},bindInput=function(){$("input[sf-bound]").each(function(){var e=$(this),t=e.parents("[sf-controller]").attr("sf-controller");if(t){var r=e.attr("sf-bound");void 0!==typeof self.root[t][r]?(e.attr("sf-bounded",r),e.removeAttr("sf-bound"),e.keyup(function(n){self.root[t][r]=e.val()}),e.attr("value","{{"+r+"}}"),bindObject(e,self.root[t],r,"attr")):console.error('Cannot get reference for self.root["'+t+'"]["'+r+'"]')}})};self.init=function(){$("[sf-repeat-this]").each(function(){var e=$(this),t=e.parent(),r=e.next();r.length&&e[0]!==r[0]||(r=!1);var n=e.before();n.length&&e[0]!==n[0]||(n=!1);var o=e.attr("sf-repeat-this");e.removeAttr("sf-repeat-this");var i=e.parents("[sf-controller]").attr("sf-controller"),a=this.outerHTML,s=loopParser(i,a,o);s?(e.remove(),s=$(s),r?s.insertBefore(r):n?s.insertAfter(n):t.append(s)):(e.attr("sf-bind-list",o.split(" in ")[1]),clearElementData(this))})},document.addEventListener("DOMNodeRemoved",function(e){if(bindingEnabled&&bindRef.length){var t=e.target;$(t).find("[sf-bind-id]").each(function(){removeBinding(this)}),removeBinding(t)}}),document.addEventListener("DOMNodeInserted",function(e){if(bindingEnabled){var t=e.target;if(t.outerHTML&&-1!==t.outerHTML.indexOf("{{")){var r=$(t),n=r.parents("sf-model");if(n.length||(n=r.parents("sf-controller")),!n.length)return}}});var removeBinding=function(e){if(e.attributes&&e.attributes["sf-bind-id"]){var t=e.attributes["sf-bind-id"].value;if(bindRef[t]){var r=bindRef[t];if(!(bindRef.cache[t].created>=Date.now()-3e3)){for(var n=0;n<r.length;n++){var o=r[n].object[r[n].propertyName];Object.defineProperty(r[n].object,r[n].propertyName,{value:o})}delete bindRef[t];var i=bindRef.cache;for(var n in i)i[n].callback&&i[n].callback[t]&&delete i[n].callback[t];bindRef.length--}}}},bindRef={length:0,index:0,cache:{}},dcBracket=/{{.*?}}/,bindObject=function(e,t,r,n){e instanceof Node||(e=e[0]);var o=bindRef.index;$(e).attr("sf-bind-id",o),bindRef.index++,bindRef.length++,bindRef.cache[o]={};var i=bindRef.cache[o];if(i.attrs={},i.innerHTML="",i.modelName=sf.controller.fromElement(e),i.model=self.root[i.modelName],i.created=Date.now(),"attr"===n||!n)for(var a in e.attributes)if(dcBracket.test(e.attributes[a].value)){var s=e.attributes[a].name;i.attrs[s]=e.attributes[a].value,"value"===s&&e.removeAttribute(s)}"html"!==n&&n||(i.innerHTML=e.innerHTML),bindRef[o]={object:t,propertyName:r},i.element=$(e);var l=function(){if("attr"===n||!n)for(var e in i.attrs)if(-1!==i.attrs[e].indexOf(r)){var t=dataParser(i.attrs[e],i.model,!1,i.modelName);"value"===e?i.element.val(t):i.element.attr(e,t);break}if("html"===n||!n){t=uniqueDataParser(i.innerHTML,i.model,!1,i.modelName);t=dataParser(t,i.model,!1,i.modelName),i.element.html(t)}};if(Object.getOwnPropertyDescriptor(i.model,r).set){for(var a in bindRef)if(bindRef[a].propertyName===r){bindRef.cache[a].callback[o]=l;break}}else{i.callback={},i.callback[o]=l;var f=t[r];Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){return f},set:function(e){for(var t in f=e,i.callback)i.callback[t]();return f}})}};self.bindElement=function(e,t=!1){var r=sf.controller.fromElement(e),n=self.root[r];if(!n)return console.error("Model for "+r+" was not found while binding:",e);var o=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(n)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g"),i=e.outerHTML;"attr"===t&&(i=i.replace(e.innerHTML,""));for(var a=i.match(/(?<={{).*?(?=}})/gs),s=0;s<a.length;s++)for(;null!==(bindable=o.exec(a[s]));)bindObject(e,n,bindable[s],t)},self.queuePreprocess=function(e=!1){for(var t=(e||document.body).childNodes,r=["html","head","style","title","link","meta","script","object","iframe"],n=0;n<r.length;n++)r[n]=r[n].toUpperCase();var o=[];for(n=0;n<t.length;n++){var i=t[n];if(-1===r.indexOf(i.nodeName))if(1===i.nodeType){if(i.attributes["sf-repeat-this"])continue;for(var a=0;a<i.attributes.length;a++)-1!==i.attributes[a].value.indexOf("{{")&&(i.setAttribute("sf-preprocess","attronly"),o.push(i));self.queuePreprocess(i)}else if(3===i.nodeType&&-1!==i.nodeValue.indexOf("{{")){i.parentNode.setAttribute("sf-preprocess","");for(a=0;a<o.length;a++)o[a].removeAttribute("sf-preprocess");return}}},self.parsePreprocess=function(e=!1){$(e||document.body).find("[sf-preprocess]").each(function(){var e=sf.controller.fromElement(this);if(this.removeAttribute("sf-preprocess"),!sf.model.root[e])return console.error("Can't parse element because model for '"+e+"' was not found",this);self.bindElement(this,$(this).attr("sf-bind"));var t=uniqueDataParser(this.innerHTML,sf.model.root[e],!1,e);this.innerHTML=dataParser(t,sf.model.root[e],!1,e);for(var r=0;r<this.attributes.length;r++)-1!==this.attributes[r].value.indexOf("{{")&&(this.attributes[r].value=dataParser(this.attributes[r].value,sf.model.root[e],!1,e))}),bindInput()}},sf.router=new function(){var e=this;e.loading=!1,e.currentPage="";var t=!1;e.init=function(r){if(!sf.loader.DOMWasLoaded)return sf(function(){e.init(r)});var n=window.location.pathname;e.lazy(),o(r),t=!0,e.currentPage=r,s=n};var r={};e.before=function(e,t,n=!1){r[e]||(r[e]=[]),!1===n?-1===r[e].indexOf(t)&&r[e].push(t):r[e][n]=t};var n={};e.after=function(e,t,r=!1){n[e]||(n[e]=[]),!1===r?-1===n[e].indexOf(t)&&n[e].push(t):n[e][r]=t};var o=function(e){if(sf.controller.run(e),r[e]){sf.model.root[e]||(sf.model.root[e]={});for(var t=0;t<r[e].length;t++)r[e][t](sf.model.root[e],sf.model.root)}sf.model.init(e)},i={loading:[],loaded:[],error:[]};e.on=function(e,t){-1===i[e].indexOf(t)&&i[e].push(t)},e.lazyViewPoint={},e.lazy=function(){$("a[href]:not([onclick])").each(function(){var e=this.href;-1===e.indexOf("#")&&(0!==e.indexOf(window.location.origin)&&"/"!==e.charAt(0)||$(this).attr("onclick","return sf.router.load(this)"))})},e.load=function(e){return!history.pushState||"ignore"==$(e).attr("sf-router")||!l(e.href.replace(window.location.origin,""))};var a=!1,s="",l=function(r){for(var l=0;l<i.loading.length;l++)i.loading[l]();var f=window.location.pathname;return t=!1,a&&a.abort(),a=loadURL(window.location.origin+r,{post:{_scarlets:".dynamic."},success:function(l){if(!t){!0,function(){if(""!==e.currentPage&&n[e.currentPage]){sf.model.root[e.currentPage]||(sf.model.root[e.currentPage]={});for(var t=0;t<n[e.currentPage].length;t++)n[e.currentPage][t](sf.model.root[e.currentPage],sf.model.root)}}(),a=!1;for(var f=!1,c=0;c<i.loaded.length;c++)f=i.loaded[c](s,r,l)||f;var d=!1;if(!f){var u=!1;for(var m in e.lazyViewPoint){if(-1!==s.indexOf(m))for(var p in e.lazyViewPoint[m])if(-1!==s.indexOf(m)){if(u=!0,(d=$(e.lazyViewPoint[m][p])).html(l),t)return;break}if(u)break}}e.lazy(),o(name,d),t=!0,!1,e.currentPage=name,s=r}},error:function(){window.history.replaceState(null,"",f);for(var e=0;e<i.error.length;e++)i.error[e]()}}),window.history.pushState(null,"",r),!0}};
//# sourceMappingURL=scarletsframe.min.js.map
