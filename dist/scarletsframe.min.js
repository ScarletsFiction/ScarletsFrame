/*
  ScarletsFrame
  A frontend library for Scarlets Framework that support
  lazy page load and element binding that can help
  simplify your code

  https://github.com/ScarletsFiction/ScarletsFrame
*/
"undefined"==typeof sf&&(sf=function(){if(arguments[0].constructor===Function)return sf.loader.onFinish.apply(null,arguments)}),setTimeout(function(){sf(sf.router.init)},10),"undefined"!=typeof $&&$.fn&&$.fn.extend||setTimeout(function(){console.clear(),console.error("Please load jQuery before before ScarletsFrame")},1e3),$.fn.extend({animateCSS:function(e,t,r){var n=this,o={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"mozAnimationEnd",WebkitAnimation:"webkitAnimationEnd"};for(var i in o)if(void 0!==n[0].style[i]){o=o[i];break}return r&&n.css("-webkit-animation-duration",r+"s").css("animation-duration",r+"s"),n.addClass("animated "+e).one(o,function(){setTimeout(function(){$(n).removeClass("animated "+e)},1),r&&$(n).css("-webkit-animation-duration","").css("animation-duration",""),"function"==typeof t&&t()}),n}}),sf.controller=new function(){var self=this,controller={};self.active={},self.for=function(e,t){sf.model.root[e]||(sf.model.root[e]={}),controller[e]=t},self.elementModel=function(e,t=!1){var r=$(e),n=sf.controller.fromElement(e);if(!n)throw"model or controller was not found";var o=r.attr("[sf-bind-list]");if(o||(o=r.parents("[sf-bind-list]").attr("sf-bind-list")),!o)return t?t(self.root[n],-1):self.root[n];var i=0;return o&&(i=r.parents("[sf-bind-list]").prevAll("[sf-bind-list]").length),t?t(self.root[n][o],i):self.root[n][o][i]},self.fromElement=function(e){var t=$(e),r=t.parents("[sf-model]").attr("sf-model");return r||(r=t.parents("[sf-controller]").attr("sf-controller")),r};var listenSFClick=function(e){var element=$(e.target),script=element.attr("sf-click");script||(element=element.parents("[sf-click]").eq(0),script=element.attr("sf-click"));var model=element.parents("[sf-model]").attr("sf-model");if(sf.model.root[model]||(model=element.parents("[sf-controller]").attr("sf-controller")),!sf.model.root[model])throw"Couldn't find model for "+model+" that was called from sf-click";var _modelScope=sf.model.root[model],modelKeys=sf.model.modelKeys(_modelScope),scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+modelKeys+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");script=script.replace(scopeMask,function(e,t){return"_modelScope."+t}),script=script.split("(");var method=script[0],method_=method;try{method=eval(method)}catch(e){method=!1}if(method){script.shift(),script=script.join("("),script=script.split(")"),script.pop(),script=script.join("("),0!==script.length&&(script=eval("["+script+"]")),script||(script=[]);try{method.apply(element,script)}catch(e){console.error("Error on sf-click for model: "+model+"\n",e.target,"\n",e)}}else console.error("Error on sf-click for model: "+model+" [Cannot find "+method_+"]\n",e.target)};self.run=function(e,t){if(!sf.loader.DOMWasLoaded)return sf(function(){self.run(e,t)});controller[e]&&(self.active[e]||(controller[e]&&controller[e](sf.model.root[e],sf.model.root),$('[sf-controller="'+e+'"]').on("click","[sf-click]",listenSFClick),self.active[e]=!0)),t&&t(sf.model.root[e],sf.model.root),controller[e]&&delete controller[e]},self.init=function(){if(!sf.loader.DOMWasLoaded)return sf(function(){self.init(name)});$("[sf-controller]").each(function(){self.run(this.attributes["sf-controller"].value)})}},sf.loader=new function(){var e=this;e.loadedContent=0,e.totalContent=1,e.DOMWasLoaded=!1;var t=[],r=[];e.onFinish=function(r){if(e.DOMWasLoaded)return r();-1===t.indexOf(r)&&t.push(r)},e.onProgress=function(t){if(e.DOMWasLoaded)return t(e.loadedContent,e.totalContent);-1===r.indexOf(t)&&r.push(t)},e.f=function(t){e.loadedContent++;for(var n=0;n<r.length;n++)r[n](e.loadedContent,e.totalContent);t&&t.removeAttribute&&t.removeAttribute("onload")},e.css=function(t){if(e.DOMWasLoaded){for(var r=t.length-1;r>=0;r--)0!==$('link[href*="'+t[r]+'"]').length&&t.splice(r,1);if(0===t.length)return}e.totalContent=e.totalContent+t.length;var n="";for(r=0;r<t.length;r++)n+='<link onload="sf.loader.f(this);" rel="stylesheet" href="'+t[r]+'">';$(function(){document.getElementsByTagName("body")[0].innerHTML+=n})},e.js=function(t,r="body"){if(e.DOMWasLoaded){for(var n=t.length-1;n>=0;n--)0!==$('script[src*="'+t[n]+'"]').length&&t.splice(n,1);if(0===t.length)return}e.totalContent=e.totalContent+t.length;for(n=0;n<t.length;n++)$.ajax({url:t[n],dataType:"script",cache:!0,success:sf.loader.f})};var n=setInterval(function(){if(/loaded|complete/.test(document.readyState)){clearInterval(n),e.DOMWasLoaded=!0;for(var o=0;o<t.length;o++)t[o]();r.splice(0),t.splice(0)}},100)},sf.prototype.constructor=sf.loader.onFinish,$(function(){$("img:not(onload)[src]").each(function(){sf.loader.totalContent++,this.setAttribute("onload","sf.loader.f(this)")})}),sf.model=new function(){var self=this,bindingEnabled=!1;self.root={},self.for=function(e,t){self.root[e]||(self.root[e]={}),t(self.root[e],self.root)},self.modelKeys=function(e){for(var t=Object.keys(e),r=t.length-1;r>=0;r--)-1!==t[r].indexOf("$")&&t.splice(r,1);return t.join("|")};var clearElementData=function(e){e.innerHTML="";for(var t=0;t<e.attributes.length;t++){var r=e.attributes[t].name;"sf-bind-list"!==r&&e.removeAttribute(r)}e.setAttribute("style","display:none")},dataParser=function(html,_model_,mask,scope,runEval=""){var _modelScope=sf.model.root[scope],scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(_modelScope)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");if(mask)var itemMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )"+mask+"\\.(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");return bindingEnabled=!0,html.replace(/{{([^@].*?)}}/g,function(actual,temp){return mask&&(temp=temp.replace(itemMask,function(e){return"_model_."+e[0].slice(1)})),temp=temp.replace(scopeMask,function(e,t){return"_modelScope."+t}),temp=temp.split("(").join("").split(")").join(""),temp=""+eval(runEval+temp),temp.replace(/[\u00A0-\u9999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})})},uniqueDataParser=function(html,_model_,mask,scope){for(var _content_={length:0,take:function(e,t){var r='"use strict";var ',n=!0;for(var o in e)"string"==typeof e[o]?e[o]='"'+e[o].split('"').join('\\"')+'"':"object"==typeof e[o]&&(e[o]=JSON.stringify(e[o])),n||(r+=","),r+=o+" = "+e[o],n=!1;return r=r.split("(").join("").split(")").join(""),dataParser(this[t],_model_,mask,scope,r+";")}},VarPass=["i","obj"],i=0;i<VarPass.length;i++)VarPass[i]+=":(typeof "+VarPass[i]+'!="undefined"?'+VarPass[i]+":null)";VarPass="{"+VarPass.join(",")+"}",html=html.replace(/{\[(.*?)\]}/gs,function(e,t){return _content_[_content_.length]=t,_content_.length++,"result += _content_.take("+VarPass+", "+(_content_.length-1)+");"});var _modelScope=sf.model.root[scope],scopeMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(_modelScope)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");if(mask)var itemMask=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )"+mask+"\\.(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g");return html.replace(/{{(@.*?)}}/gs,function(actual,temp){mask&&(temp=temp.replace(itemMask,function(e){return"_model_."+e[1].slice(1)})),temp=temp.replace(scopeMask,function(e){return"_modelScope."+e[1].slice(1)}),temp=temp.split(":"),temp[0]=temp[0].split("(").join("").split(")").join(""),temp=temp.join(":");var result="",check=!1;if(check=temp.split("@if "),1!=check.length&&(check=check[1].split(":"),eval(check[0])&&(check.shift(),result=check.join(":"))),check=temp.split("@call"),1!=check.length){check=check[1].trim();var call=check.split("@"),args=[];if(1!==call.length){args=call[1],args=args.split(" ").join("").split(",");for(var a=0;a<args.length;a++)args[a]=eval(args[a])}if(call=call[0],!sf.model.root[scope][call])throw"'"+call+"' was not available inside '"+scope+"' model";var values=sf.model.root[scope][call].apply(null,args);result=values}if(check=temp.split("@exec"),1!=check.length){check=check[1].split("&lt;").join("<").split("&gt;").join(">").split("&amp;").join("&");for(var regex=/(for|if|while)#(.*?):/gs,match=regex.exec(check);null!==match;)check=check.replace(match[0],match[1]+"("+match[2]+")"),match=regex.exec(check);var currentIndex=i;try{eval(check)}catch(e){return void console.error("Error in @exec with message: "+e.message)}i=currentIndex}return result})},bindArray=function(e,t,r,n,o){for(var i=JSON.parse(JSON.stringify(t)),a=["pop","push","splice","shift","unshift","refreshBind"],l=function(t,i=!1,a=!1){var l=$("[sf-model='"+n+"']");if(0===l.length&&(l=$("[sf-controller='"+n+"']")),0!==l.length){l=l.find("[sf-bind-list='"+o+"']");var s=!1;if(self.root[n]["on$"+o]&&(s=self.root[n]["on$"+o]),i){var f=self.root[n][o][t],c=dataParser(e,f,r,n);c=uniqueDataParser(c,f,r,n),c=$(c),l[t]?a?(s.create&&s.create(c[0]),c.insertBefore(l[0])):(s.update&&s.update(c[0]),l[t].outerHTML=c[0].outerHTML):(s.create&&s.create(c[0]),c.insertAfter(l[l.length-1]))}else if(l[t]){var d=!1,u=function(){if(!d){if(d=!0,l.length<=1)return clearElementData(l[t]);l[t].remove()}};s.remove?s.remove(l[t],u)||setTimeout(u,800):u()}}},s=function(e,t){Object.defineProperty(e,t,{enumerable:!1,configurable:!0,value:function(){var e=void 0;if(Array.prototype[t]&&(e=Array.prototype[t].apply(this,arguments)),"pop"===t)l(this.length);else if("push"===t)l(this.length-1,!0);else if("shift"===t)l(0);else if("splice"===t)if(arguments.length>=3)arguments[0]=!1,t="refreshBind";else{var r=arguments[0];r<0&&(r=this.length+r+1);var n=arguments[1];n||(n=this.length-r);for(var o=0;o<n;o++)l(r)}else"unshift"===t&&l(0,!0,!0);if("refreshBind"===t)if(arguments[0]||0===arguments[0])l(arguments[0],!0);else{var a=!1;for(o=0;o<this.length;o++)JSON.stringify(i[o])!==JSON.stringify(this[o])&&(a=!0,l(o,!0));a&&(i=JSON.parse(JSON.stringify(this)))}return e}})},f=0;f<a.length;f++)s(t,a[f])},loopParser=function(e,t,r){var n="",o=r.split(" in "),i=o[0];if(!sf.model.root[e])return console.error("Can't parse element because model for '"+e+"' was not found",$(t)[0]);var a=self.root[e][o[1]];if(t=(t=$(t).attr("sf-bind-list",o[1])[0].outerHTML).replace(/  +|\t+/g,""),2===o.length){for(var l in a){var s=a[l];temp=dataParser(t,s,i,e),temp=uniqueDataParser(temp,s,i,e),n+=temp}Object.defineProperty(self.root[e],o[1],{enumerable:!0,configurable:!0,get:function(){return a},set:function(e){for(var t=0;t<e.length;t++)a[t]?(a[t]=e[t],a.refreshBind(t)):a.push(e[t]);return a.length>e.length&&a.splice(a.length-e.length),a}}),bindArray(t,a,i,e,o[1])}return n},bindInput=function(){$("input[sf-bound]").each(function(){var e=$(this),t=e.parents("[sf-controller]").attr("sf-controller");if(t){var r=e.attr("sf-bound");void 0!==typeof self.root[t][r]?(e.attr("sf-bounded",r),e.removeAttr("sf-bound"),e.keyup(function(n){self.root[t][r]=e.val()}),e.attr("value","{{"+r+"}}"),bindObject(e,self.root[t],r,"attr")):console.error('Cannot get reference for self.root["'+t+'"]["'+r+'"]')}})};self.init=function(e=!1){sf.model.queuePreprocess(e),sf.model.parsePreprocess(e),$("[sf-repeat-this]").each(function(){var e=$(this),t=e.parent(),r=e.next();r.length&&e[0]!==r[0]||(r=!1);var n=e.before();n.length&&e[0]!==n[0]||(n=!1);var o=e.attr("sf-repeat-this");e.removeAttr("sf-repeat-this");var i=e.parents("[sf-controller]").attr("sf-controller"),a=this.outerHTML,l=loopParser(i,a,o);l?(e.remove(),l=$(l),r?l.insertBefore(r):n?l.insertAfter(n):t.append(l)):(e.attr("sf-bind-list",o.split(" in ")[1]),clearElementData(this))})},document.addEventListener("DOMNodeRemoved",function(e){if(bindingEnabled&&bindRef.length){var t=e.target,r=[];$(t).find("[sf-controller]").each(function(){r.push(this.attributes["sf-controller"].value)}),t.attributes&&t.attributes["sf-controller"]&&r.push(t.attributes["sf-controller"].value),$(t).find("[sf-bind-id], [sf-bind-list], [sf-bounded], [sf-repeat-this]").each(function(){removeBinding(this,r)}),removeBinding(t)}});var removeBinding=function(e,t=!1){if(e.attributes){var r=e.attributes;if(r["sf-bind-id"]){var n=r["sf-bind-id"].value;if(!bindRef[n])return;for(var o=bindRef[n],i=0;i<o.propertyName.length;i++){var a=o.object[o.propertyName[i]];Object.defineProperty(o.object,o.propertyName[i],{configurable:!0,value:a})}delete bindRef[n];var l=bindRef.cache;for(var i in l)l[i].callback&&l[i].callback[n]&&delete l[i].callback[n],$.isEmptyObject(l[i].callback)&&delete l[i];l[n]&&(delete l[n].attrs,delete l[n].innerHTML,delete l[n].modelName,delete l[n].model,delete l[n].created,delete l[n].element),bindRef.length--,0===bindRef.length&&(bindRef.index=0)}if(t){var s=!1;r["sf-bind-list"]&&(s=r["sf-bind-list"].value),r["sf-repeat-this"]&&(s=r["sf-repeat-this"].value.split(" in ")[1]),r["sf-bounded"]&&(s=r["sf-bounded"].value);for(i=0;i<t.length;i++){var f=self.root[t[i]];if(f[s]){a=f[s];Object.defineProperty(f,s,{configurable:!0,value:a})}}}}},bindRef={length:0,index:0,cache:{}};self.bindRef=bindRef;var dcBracket=/{{.*?}}/,bindObject=function(e,t,r,n){e instanceof Node||(e=e[0]);var o=bindRef.index;$(e).attr("sf-bind-id",o),bindRef.index++,bindRef.length++,bindRef.cache[o]={};var i=bindRef.cache[o];if(i.attrs={},i.innerHTML="",i.modelName=sf.controller.fromElement(e),i.model=self.root[i.modelName],i.created=Date.now(),"attr"===n||!n)for(var a in e.attributes)if(dcBracket.test(e.attributes[a].value)){var l=e.attributes[a].name;i.attrs[l]=e.attributes[a].value,"value"===l&&e.removeAttribute(l)}"html"!==n&&n||(i.innerHTML=e.innerHTML),bindRef[o]||(bindRef[o]={object:t,propertyName:[]}),bindRef[o].propertyName.push(r),i.element=$(e);var s=function(){if("attr"===n||!n)for(var e in i.attrs)if(-1!==i.attrs[e].indexOf(r)){var t=dataParser(i.attrs[e],i.model,!1,i.modelName);"value"===e?i.element.val(t):i.element.attr(e,t);break}if("html"===n||!n){t=uniqueDataParser(i.innerHTML,i.model,!1,i.modelName);t=dataParser(t,i.model,!1,i.modelName),i.element.html(t)}};if(Object.getOwnPropertyDescriptor(i.model,r).set){for(var a in bindRef)if(i.model===bindRef[a].object&&-1!==bindRef[a].propertyName.indexOf(r)){bindRef.cache[a].callback[o]=s;break}}else{i.callback={},i.callback[o]=s;var f=t[r];Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){return f},set:function(e){for(var t in f=e,i.callback)i.callback[t]();return f}})}};self.bindElement=function(e,t=!1){var r=sf.controller.fromElement(e),n=self.root[r];if(!n)return console.error("Model for "+r+" was not found while binding:",e);var o=RegExp("(?<=\\b[^.]|^|\\n| +|\\t|\\W )("+self.modelKeys(n)+")(?=(?:[^\"']*(?:'|\")[^\"']*(?:'|\"))*[^\"']*$)\\b","g"),i=e.outerHTML;"attr"===t&&(i=i.replace(e.innerHTML,""));for(var a=i.match(/(?<={{).*?(?=}})/gs),l=0;l<a.length;l++)for(;null!==(bindable=o.exec(a[l]));)bindObject(e,n,bindable[l],t)},self.queuePreprocess=function(e=!1){for(var t=(e||document.body).childNodes,r=["html","head","style","link","meta","script","object","iframe"],n=0;n<r.length;n++)r[n]=r[n].toUpperCase();var o=[];for(n=0;n<t.length;n++){var i=t[n];if(-1===r.indexOf(i.nodeName))if(1===i.nodeType){var a=i.attributes;if(a["sf-bind-id"]||a["sf-repeat-this"]||a["sf-bind-list"])continue;for(var l=0;l<a.length;l++)-1!==a[l].value.indexOf("{{")&&(i.setAttribute("sf-preprocess","attronly"),o.push(i));self.queuePreprocess(i)}else if(3===i.nodeType&&-1!==i.nodeValue.indexOf("{{")){i.parentNode.setAttribute("sf-preprocess","");for(l=0;l<o.length;l++)o[l].removeAttribute("sf-preprocess");return}}},self.parsePreprocess=function(e=!1){$(e||document.body).find("[sf-preprocess]").each(function(){var e=sf.controller.fromElement(this);if(this.removeAttribute("sf-preprocess"),!sf.model.root[e])return console.error("Can't parse element because model for '"+e+"' was not found",this);self.bindElement(this,$(this).attr("sf-bind"));var t=uniqueDataParser(this.innerHTML,sf.model.root[e],!1,e);this.innerHTML=dataParser(t,sf.model.root[e],!1,e);for(var r=0;r<this.attributes.length;r++)-1!==this.attributes[r].value.indexOf("{{")&&(this.attributes[r].value=dataParser(this.attributes[r].value,sf.model.root[e],!1,e))}),bindInput()}},sf.router=new function(){var e=this;e.loading=!1,e.enabled=!1,e.currentPage=[];var t=!1,r=!1,n="";e.init=function(){if(!sf.loader.DOMWasLoaded)return sf(function(){e.init()});e.lazy(),$("[sf-page]").each(function(){var e=this.attributes["sf-page"].value;a(e)}),t=!0,n=window.location.pathname},e.enable=function(t=!0){e.enabled=t,t?e.lazy():$("a[href][onclick]").each(function(){var e=$(this);"return sf.router.load(this)"===e.attr("onclick")&&e.removeAttr("onclick")})};var o={};e.before=function(e,t,r=!1){o[e]||(o[e]=[]),!1===r?-1===o[e].indexOf(t)&&o[e].push(t):o[e][r]=t};var i={};e.after=function(e,t,r=!1){i[e]||(i[e]=[]),!1===r?-1===i[e].indexOf(t)&&i[e].push(t):i[e][r]=t};var a=function(t,r=!1){if(-1===e.currentPage.indexOf(t)&&e.currentPage.push(t),sf.controller.init(),sf.model.init(r),o[t]){sf.model.root[t]||(sf.model.root[t]={});for(var n=0;n<o[t].length;n++)o[t][n](sf.model.root)}},l={loading:[],loaded:[],special:[],error:[]};e.on=function(e,t){-1===l[e].indexOf(t)&&l[e].push(t)},e.lazyViewPoint={},e.lazy=function(){e.enabled&&$("a[href]:not([onclick])").each(function(){var e=this.href;-1===e.indexOf("#")&&(0!==e.indexOf(window.location.origin)&&"/"!==e.charAt(0)||$(this).attr("onclick","return sf.router.load(this)"))})},e.load=function(e){return!history.pushState||"ignore"==$(e).attr("sf-router")||!s(e.href.replace(window.location.origin,""))};var s=function(o){for(var s=0;s<l.loading.length;s++)if(l.loading[s](o))return;window.location.pathname;return t=!1,r&&r.abort(),r=loadURL(window.location.origin+o,{data:{_scarlets:".dynamic."},success:function(s){if(!t){!0,r=!1;var c=!1,d={};if(s=s.replace(/<!-- SF-Special:(.*?)-->(?=(?:[^"\']*(?:\'|")[^"\']*(?:\'|"))*[^"\']*$)/g,function(e,t){var r=t.split("--|&>").join("--\x3e");return d=Object.assign(d,JSON.parse(r)),""}),!$.isEmptyObject(d))for(var u=0;u<l.special.length;u++)if(l.special[u](d))return;for(u=0;u<l.loaded.length;u++)c=l.loaded[u](n,o,s)||c;var m=!1;if(!c){var p=function(t){(function(){if(-1===e.currentPage.indexOf(name)&&e.currentPage.splice(e.currentPage.indexOf(name),1),""!==e.currentPage&&i[e.currentPage]){sf.model.root[e.currentPage]||(sf.model.root[e.currentPage]={});for(var t=0;t<i[e.currentPage].length;t++)i[e.currentPage][t](sf.model.root)}})((m=$(t)).find("[sf-page]")),m.html(s);var r=m.find("title").eq(0).html();r&&$("head title").html(r),h=!0},h=!1;for(var b in e.lazyViewPoint){if(-1!==n.indexOf(b))for(var v in e.lazyViewPoint[b])if(-1!==n.indexOf(b)){p(e.lazyViewPoint[b][v]);break}if(h)break}if(!h&&(sf.router.lazyViewPoint["@default"]&&p(sf.router.lazyViewPoint["@default"]),!h))for(u=0;u<l.error.length;u++)l.error[u]('sf.router.lazyViewPoint["'+b+'"]["'+v+'"] was not found');if(t)return}e.lazy(),m||(m=$("body")),m.find("[sf-controller], [sf-page]").each(function(){this.attributes["sf-controller"]&&sf.controller.run(this.attributes["sf-controller"].value),this.attributes["sf-page"]&&a(this.attributes["sf-page"].value,m[0])}),t=!0,!1,n=o,f=!1}},error:function(e,t){r=!1;for(var n=0;n<l.error.length;n++)l.error[n](e.status,t);f=!0,window.history.back()}}),window.history.pushState(null,"",o),!0},f=!1;window.addEventListener("popstate",function(e){f?f=!1:s(window.location.pathname)},!1)};
//# sourceMappingURL=scarletsframe.min.js.map
